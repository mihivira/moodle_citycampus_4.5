{"version":3,"file":"course_detail.min.js","sources":["../src/course_detail.js"],"sourcesContent":["define([ 'local_hoteles_city_dashboard/graphics_courses', 'local_hoteles_city_dashboard/utils'], function(graphicsCourses, utils) {\n\n    var CourseDetail = {\n        datatable: null,\n        reportCourses: '',\n        config: {},\n        intervals: 0,\n        columns: [],\n        id_div_grafica: 'curso_graficas'\n    };\n\n    CourseDetail.init = function(config) {\n        this.config = config;\n        this.reportCourses = config.courseid != -1 ? config.courseid : \"\";\n        \n        console.log('CourseDetail init with config:', this.config);\n        this.config.ajax_code = this.parseAjaxCode(this.config.ajax_code || []);\n        \n        this.initEvents();\n        this.initializeChoices();\n        this.initDataTable();\n        \n    };\n\n     /**\n     * Initialize Choices.js for multiselect elements\n     */\n    CourseDetail.initializeChoices = function() {\n        $('.multiselect-setting').each(function(index, element) {\n            // You'll need to include Choices.js as a dependency or use Moodle's built-in select components\n            var multipleCancelButton = new Choices( '#' + element.id, { removeItemButton: true, searchEnabled: true,\n                    placeholderValue: 'Presione aquí para agregar un filtro', searchPlaceholderValue: 'Buscar filtro',\n                    placeholder: true,\n                } );\n        });\n    }\n\n\n    CourseDetail.initEvents = function() {\n        console.log('Inicializando eventos para CourseDetail');\n\n        var self = this;\n        \n        $(document).on('click', '#search_btn', function() {\n            self.reportCourses = $('#report_courses').val();\n            if (self.datatable) {\n                self.datatable.ajax.reload();\n            }\n        });\n\n        $(document).on('click', '#quitar_cursos', function() {\n            self.quitarCursos();\n        });\n\n        $(document).on('click', '#todos_cursos, #descargar_cursos', function() {\n            self.todosCursos();\n        });\n    };\n\n    CourseDetail.initDataTable = function() {\n        console.log('Inicializando DataTable para CourseDetail');\n        var self = this;\n        \n        if ($('#empTable').length === 0) {\n            console.log('No se encontró la tabla #empTable');\n            return;\n        }\n\n        // Destruir DataTable existente si ya existe\n        if ($.fn.DataTable.isDataTable('#empTable')) {\n            console.log('Destruyendo DataTable existente');\n            $('#empTable').DataTable().destroy();\n        }\n        \n        this.datatable = $('#empTable').DataTable({\n            'processing': true,\n            'serverSide': true,\n            'serverMethod': 'post',\n            'initComplete': function() {\n                console.log('DataTable inicializado');\n                $('.dataTables_filter input').off('keyup.DT input.DT');\n                $('.dataTables_filter input').on('keyup', function(e){\n                    var code = e.keyCode || e.which;\n                    if (code == 13) {\n                        self.datatable.search(this.value).draw();\n                    }\n                });\n            },\n            'ajax': {\n                'url': self.config.wwwroot + '/local/hoteles_city_dashboard/services.php',\n                'data': function(d) {\n                    d['request_type'] = 'course_users_pagination';\n                    d['reportCourses'] = self.reportCourses || '';\n                    console.log('Enviando datos AJAX:', d);\n                    self.mostrarGraficaDeCursos();\n                    \n                    if(self.reportCourses && self.reportCourses > 0){\n                        self.selectCurso(self.reportCourses);\n                    }\n                },\n                 'dataSrc': function(json) {\n                    console.log('Respuesta AJAX recibida:', json);\n                    if (json.error) {\n                        console.error('Error del servidor:', json.error);\n                        return [];\n                    }\n                    // Asegurarse de que json.data existe\n                    var data = json.data || json.aaData || [];\n                    console.log('Datos procesados:', data);\n                    return data;\n                }\n            },\n            'lengthMenu': [\n                [ -1],\n                [\"Todos los registros\"]\n            ],\n            'dom': 'Bfrtip',\n            'pageLength': -1,\n            'buttons': [{\n                extend: 'excelHtml5',\n                text: '<span class=\"fa fa-file-excel-o\"></span> Exportar a excel',\n                exportOptions: {\n                    modifier: {\n                        search: 'applied',\n                        order: 'applied'\n                    },\n                    columns: self.parseColumns(self.config.ajax_printed_rows)\n                }\n            }, {\n                extend: 'csvHtml5',\n                text: '<span class=\"fa fa-file-o\"></span> Exportar a CSV',\n                exportOptions: {\n                    modifier: {\n                        search: 'applied',\n                        order: 'applied'\n                    },\n                    columns: self.parseColumns(self.config.ajax_printed_rows)\n                }\n            }, 'pageLength'],\n            'columns': self.parseAjaxCode(self.config.ajax_code),\n            'language': {\n                \"url\": \"datatables/Spanish.json\",\n                \"emptyTable\": \"No se encontró información\",\n                \"loadingRecords\": \"Cargando...\",\n                \"processing\": \"<div class='spinner'></div>\",\n                \"search\": \"Búsqueda:\",\n                \"paginate\": {\n                    \"first\": \"Primera\",\n                    \"last\": \"Última\",\n                    \"next\": \"Siguiente\",\n                    \"previous\": \"Anterior\"\n                },\n                \"buttons\": {\n                    \"pageLength\": {\n                        \"_\": \"Mostrando %d filas\",\n                        \"-1\": \"Mostrando todas las filas\"\n                    }\n                }\n            },\n            \"columnDefs\": [{\n                \"targets\": self.parseColumns(self.config.ajax_link_fields),\n                \"orderable\": false\n            }]\n        });\n\n        $.fn.dataTable.ext.errMode = 'throw';\n        console.log('DataTable inicializado correctamente');\n    };\n\n    CourseDetail.parseColumns = function(columnString) {\n        if (!columnString) return [];\n        return columnString.split(',').map(Number);\n    };\n\n    CourseDetail.parseAjaxCode = function(ajaxCode) {\n        \n\n        const columns = ajaxCode;\n\n        //recorrer columns\n        columns.forEach((column, index) => {\n            if (column.data === 'link_edit_user') {\n                column.render = function(data, type, row) {\n                        return `<a target=\"_self\" class=\"btn btn-primary\" href=\"administrar_usuarios.php?id=${data}\">Editar usuario</a>`;\n                    };\n                } else if (column.data === 'name') {\n                    column.render = function(data, type, row) {\n                        const parts = data.split('||'); // nombre||id\n                        return `<a class=\"_blank\" href=\"administrar_usuarios.php?id=${parts[1]}\">${parts[0]}</a>`;\n                    };\n                } else if (column.data === 'link_suspend_user') {\n                    column.render = function(data, type, row) {\n                        const arrSusp = data.split('||'); // estado||id\n                        const clase = arrSusp[1] === '1' ? 'btn btn-danger' : 'btn btn-success';\n                        const texto = arrSusp[1] === '1' ?  'Activar' : 'Suspender';\n                        const id = arrSusp[0]; // Assuming 'id' is the second part\n                        return `<button class=\"confirm-action ${clase}\" data-id=\"${id}\" data-texto=\"${texto}\">${texto}</button>`;\n                    };\n                } else if (column.data === 'link_libro_calificaciones') {\n                    column.render = function(data, type, row) {\n                        const parts = data.split('||'); // id||courseid  \n                        return `<a target=\"_blank\" class=\"btn btn-primary\" href=\"${this.config.wwwroot}/grade/report/user/index.php?id=${parts[1]}&userid=${parts[0]}\">Libro de calificaciones</a>`;\n                    }.bind(this);\n                }\n            });\n\n            console.log('Parsed columns:', columns);\n            \n            return columns;\n        \n    };\n\n    CourseDetail.mostrarGraficaDeCursos = function() {\n        var self = this;\n        var courseId = this.reportCourses;\n\n        console.log('Mostrando curso(s): ', courseId);\n\n        //reviar si courseId es un array o un string\n        if (Array.isArray(courseId)) {\n            courseId = courseId.toString();\n        } \n\n        \n        \n        \n        var peticion = {\n            request_type: 'course_completion',\n            courseid: courseId || ''\n        };\n\n        console.log('Enviando petición para mostrar gráfica de cursos:', peticion);\n\n        $.ajax({\n            type: \"POST\",\n            url: this.config.wwwroot + \"/local/hoteles_city_dashboard/services.php\",\n            data: peticion,\n            dataType: \"json\"\n        })\n        .done(function(data) {\n            if (data && data.data) {\n                var informacion = data.data;\n                \n                self.cleanDiv();\n                    \n                \n                \n                // Aquí iría la lógica de GraphicsDashboard\n                console.log('Información recibida:', informacion);\n\n                informacion = utils.getPercentages(informacion);\n                informacion.title = informacion.title || 'Gráfica de Cursos';\n                var course = new graphicsCourses(self.id_div_grafica, informacion.title, informacion.chart, informacion, 12, informacion.id);\n                if(informacion.enrolled_users > 0) {\n                    course.printCardCourseInfo();\n                    // Renderizar la gráfica después de crear el elemento\n                    setTimeout((function(course_instance, course_info) {\n                        return function() {\n                            utils.renderCourseChart(course_instance, course_info);\n                        };\n                    })(course, informacion), 100);\n                } else {\n                    course.printCardSinInfo();\n                }\n                self.showPage();\n\n            }\n        })\n        .fail(function(xhr, status, error) {\n            console.log('Error en mostrarGraficaDeCursos:', error);\n            self.showPage();\n        });\n    };\n\n    CourseDetail.cleanDiv = function() {\n        var graficaDiv = document.getElementById(this.id_div_grafica);\n        if (graficaDiv) {\n            graficaDiv.innerHTML = '';\n        }\n    };\n\n    CourseDetail.showPage = function() {\n        // Lógica para mostrar la página si es necesario\n    };\n\n    CourseDetail.quitarCursos = function() {\n        $('#report_courses').val(null);\n        this.reportCourses = \"\";\n        if (this.datatable) {\n            this.datatable.ajax.reload();\n        }\n    };\n\n    CourseDetail.todosCursos = function() {\n        var allCourses = [];\n        $('#report_courses option').map(function() {\n            allCourses.push(this.value);\n        }).get();\n        $('#report_courses').val(allCourses);\n        this.reportCourses = allCourses.join(',');\n        if (this.datatable) {\n            this.datatable.ajax.reload();\n        }\n    };\n\n    CourseDetail.selectCurso = function(courseid) {\n        $('#report_courses').val([courseid]);\n    };\n\n    CourseDetail.descargarReporte = function() {\n        var courseId = this.reportCourses || this.config.default_courses;\n        var url = this.config.wwwroot + \"/local/hoteles_city_dashboard/descargar_reporte.php?course=\" + courseId;\n        alert(\"Este proceso demora varios minutos, por lo tanto no abandones la sesión, ni vuelvas a dar clic en el botón hasta que se descargue el documento.\");\n        window.location.href = url;\n        $(\"#exampleModal\").modal('show');\n    };\n\n    // Función para redimensionar iframe (manteniendo compatibilidad)\n    CourseDetail.iResize = function(frame_id) {\n        if(this.intervals > 60){\n            return;\n        }\n        this.intervals++;\n        var element = document.getElementById(frame_id);\n        if(element != null){\n            if(element.contentWindow != null){\n                if(element.contentWindow.document != null){\n                    if(element.contentWindow.document.body != null){\n                        if(element.contentWindow.document.body.offsetHeight != null){\n                            var size = (element.contentWindow.document.body.offsetHeight + 500 ) + 'px';\n                            document.getElementById(frame_id).style.height = \"1500px\";\n                        }\n                    }\n                }\n            }\n        }\n    };\n\n    \n\n    return CourseDetail;\n});"],"names":["define","graphicsCourses","utils","CourseDetail","datatable","reportCourses","config","intervals","columns","id_div_grafica","courseid","console","log","this","ajax_code","parseAjaxCode","initEvents","initializeChoices","initDataTable","$","each","index","element","Choices","id","removeItemButton","searchEnabled","placeholderValue","searchPlaceholderValue","placeholder","self","document","on","val","ajax","reload","quitarCursos","todosCursos","length","fn","DataTable","isDataTable","destroy","off","e","keyCode","which","search","value","draw","wwwroot","d","mostrarGraficaDeCursos","selectCurso","json","error","data","aaData","extend","text","exportOptions","modifier","order","parseColumns","ajax_printed_rows","ajax_link_fields","dataTable","ext","errMode","columnString","split","map","Number","ajaxCode","forEach","column","render","type","row","parts","arrSusp","clase","texto","bind","courseId","Array","isArray","toString","peticion","request_type","url","dataType","done","informacion","cleanDiv","getPercentages","title","course","chart","enrolled_users","printCardCourseInfo","setTimeout","course_instance","course_info","renderCourseChart","printCardSinInfo","showPage","fail","xhr","status","graficaDiv","getElementById","innerHTML","allCourses","push","get","join","default_courses","alert","window","location","href","modal","frame_id","contentWindow","body","offsetHeight","style","height"],"mappings":"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"}