{"version":3,"file":"status_cursos.min.js","sources":["../src/status_cursos.js"],"sourcesContent":["define([\n    'jquery',\n    'core/chartjs',\n    'core/ajax',\n    'core/templates',\n    'core/notification',\n    'local_hoteles_city_dashboard/graphics_courses'\n], function($, Chart, Ajax, Templates, Notification, GraphicsDashboard) {\n\n    var pageCurrent = 1;\n    var items = 0;\n    var informacion = '';\n    var comparativeChart = null;\n\n    /**\n     * Initialize the module\n     */\n    function init() {\n        $(document).ready(function() {\n            initializeChoices();\n            obtenerGraficas();\n            setupEventListeners();\n        });\n    }\n\n    /**\n     * Initialize Choices.js for multiselect elements\n     */\n    function initializeChoices() {\n        $('.multiselect-setting').each(function(index, element) {\n            // You'll need to include Choices.js as a dependency or use Moodle's built-in select components\n            var multipleCancelButton = new Choices( '#' + element.id, { removeItemButton: true, searchEnabled: true,\n                    placeholderValue: 'Presione aquí para agregar un filtro', searchPlaceholderValue: 'Buscar filtro',\n                    placeholder: true,\n                } );\n        });\n    }\n\n    /**\n     * Setup event listeners\n     */\n    function setupEventListeners() {\n        $('#apply-filters-btn').on('click', function(e) {\n            e.preventDefault();\n            obtenerGraficas();\n            modalLoader();\n        });\n    }\n\n    /**\n     * Show loader modal\n     */\n    function modalLoader() {\n        $('#exampleModal').modal('show');\n    }\n\n    /**\n     * Hide loader modal\n     */\n    function hideLoader() {\n        $('#exampleModal').modal('hide');\n    }\n\n    /**\n     * Get graphics data\n     */\n    function obtenerGraficas() {\n        var peticion = $('#local_hoteles_city_dashboard_filters').serializeArray();\n        peticion.push({name: 'request_type', value: 'course_list'});\n\n        $.ajax({\n            type: \"POST\",\n            url: M.cfg.wwwroot + \"/local/hoteles_city_dashboard/services.php\",\n            data: peticion,\n            dataType: \"json\"\n        })\n        .done(function(data) {\n            informacion = data.data;\n\n            console.log('Data received:', data);\n            \n            cleanDiv();\n            $('#div_comparativa').html('<canvas id=\"grafica_comparativa\" width=\"400\" height=\"200\"></canvas>');\n            comparative(informacion);\n\n            if(informacion[0] !== undefined && informacion[0].query) {\n                var filtros = informacion[0].query;\n                var prueba = JSON.parse(filtros);\n                var custom = '';\n                for(const prop in prueba) {\n                    if(prop === 'institution') {\n                        if(typeof prueba.institution === \"object\") {\n                            var f_uo = prueba.institution;\n                            $('#uo').html(JSON.stringify(f_uo));\n                        } else {\n                            $('#uo').html('');\n                        }\n                    } else if(prop === 'department') {\n                        $('#puesto').html(prueba[prop]);\n                    } else {\n                        custom += prueba[prop] + '<br><br>';\n                        $('#marca').html(custom);\n                    }\n                }\n            }\n\n            items = getNumPages(informacion.length);\n            var itemsPage = '<ul class=\"pagination\">' +\n                          '<li class=\"page-item\">' +\n                          '<a class=\"page-link\" href=\"#pag-content\" aria-label=\"Previous\" onclick=\"pagePrev(); return false;\">' +\n                          '<span aria-hidden=\"true\">&laquo;</span>' +\n                          '<span class=\"sr-only\">Previous</span>' +\n                          '</a>' +\n                          '</li>';\n                          \n            for(var i = 0; i < items; i++) {\n                itemsPage = agregaItemPag(itemsPage, i + 1);\n            }\n            \n            itemsPage += '<li class=\"page-item\">' +\n                        '<a class=\"page-link\" href=\"#pag-content\" aria-label=\"Next\" onclick=\"pageNext(); return false;\">' +\n                        '<span aria-hidden=\"true\">&raquo;</span>' +\n                        '<span class=\"sr-only\">Next</span>' +\n                        '</a>' +\n                        '</li>' +\n                        '</ul>';\n                        \n            $(\"#paginacion\").html(itemsPage);\n            getInformationToPage();\n            hideLoader();\n        })\n        .fail(function(error, error2) {\n            console.log('Entra a fail');\n            console.log(error);\n            console.log(error2);\n            hideLoader();\n        });\n    }\n\n    /**\n     * Get information for current page\n     */\n    function getInformationToPage() {\n        var min = getMinIndex(pageCurrent);\n        var max = getMaxIndex(pageCurrent);\n\n        document.getElementById('curso_graficas').innerHTML = '';\n        \n        // Limpiar clases active de paginación\n        $(\".page-item\").removeClass('active');\n        $(\"#page\" + pageCurrent).addClass('active');\n\n        for(var i = 0; i < informacion.length; i++) {\n            if(i >= min && i < max) {\n                var info = informacion[i];\n\n                var course = new GraphicsDashboard('curso_graficas', info.title, info.chart, info, 4, info.id);\n                if(info.enrolled_users > 0) {\n                    course.printCardCourseInfo();\n                    // Renderizar la gráfica después de crear el elemento\n                    setTimeout((function(course_instance, course_info) {\n                        return function() {\n                            renderCourseChart(course_instance, course_info);\n                        };\n                    })(course, info), 100);\n                } else {\n                    course.printCardSinInfo();\n                }\n\n                // Actualizar porcentajes\n                setTimeout((function(info_copy) {\n                    return function() {\n                        if($('#aprobados' + info_copy.id).length) {\n                            $('#aprobados' + info_copy.id).html(info_copy.percentage + \"%\");\n                            var na = 100 - info_copy.percentage;\n                            var not_approved_users = na.toFixed(2);\n                            var dec = not_approved_users.split(\".\");\n                            \n                            if(dec[1] === \"00\" || dec[1] === \"0\" || dec[1] === 0) {\n                                $('#no_aprobados' + info_copy.id).html(na + \"%\");\n                            } else {\n                                $('#no_aprobados' + info_copy.id).html(not_approved_users + \"%\");\n                            }\n                            $('#inscritos' + info_copy.id).html(info_copy.enrolled_users);\n                        }\n                    };\n                })(info), 150);\n            }\n        }\n    }\n\n    /**\n     * Render course chart\n     */\n    function renderCourseChart(course, info) {\n        console.log('Rendering chart for:', info.id, 'Type:', info.chart);\n        \n        if(info.chart === 'bar-agrupadas' || info.chart === 'horizontalBar' || \n           info.chart === 'line' || info.chart === 'burbuja') {\n            course.comparative_graph();\n        } else if(info.chart === 'pie' || info.chart === 'bar') {\n            course.individual_graph();\n        } else {\n            // Default to comparative graph\n            course.comparative_graph();\n        }\n    }\n\n    /**\n     * Get number of pages\n     */\n    function getNumPages(n) {\n        if(n % 10 > 0 && n % 10 < 5) {\n            return Math.round(n / 10) + 1;\n        } else {\n            return Math.round(n / 10);\n        }\n    }\n\n    /**\n     * Clean div elements\n     */\n    function cleanDiv() {\n        // Destruir chart comparativa si existe\n        if(comparativeChart) {\n            comparativeChart.destroy();\n            comparativeChart = null;\n        }\n        \n        document.getElementById('curso_graficas').innerHTML = '';\n        document.getElementById('uo').innerHTML = '';\n        document.getElementById('puesto').innerHTML = '';\n        document.getElementById('marca').innerHTML = '';\n        document.getElementById('region').innerHTML = '';\n    }\n\n    /**\n     * Comparative chart\n     */\n    function comparative(informacion) {\n        if(informacion.length === 0) return;\n        \n        var data_labels = [];\n        var arr_completado_percantage = [];\n        var arr_nocompletado_percentage = [];\n        \n        for(var i = 0; i < informacion.length; i++) {\n            var info = informacion[i];\n            data_labels.push(info.title || 'Curso ' + (i+1));\n            arr_completado_percantage.push(Math.max(0, info.percentage || 0));\n            var approved_users = Math.max(0, info.percentage || 0);\n            var not_approved = Math.max(0, 100 - approved_users);\n            var percentage_not_approved = not_approved.toFixed(2);\n            arr_nocompletado_percentage.push(parseFloat(percentage_not_approved));\n        }\n        \n        var datasets_completado = { \n            label: 'Completado', \n            backgroundColor: '#1cc88a', \n            stack: 'Stack 0', \n            data: arr_completado_percantage \n        };\n        var datasets_nocompletado = { \n            label: 'No Completado', \n            backgroundColor: '#e74a3b', \n            stack: 'Stack 0', \n            data: arr_nocompletado_percentage \n        };\n        \n        var dataset = [datasets_completado, datasets_nocompletado];\n        var d_graph = { labels: data_labels, datasets: dataset };\n        \n        var ctx = document.getElementById('grafica_comparativa');\n        if(ctx) {\n            // Destruir instancia anterior si existe\n            if(comparativeChart) {\n                comparativeChart.destroy();\n            }\n            \n            ctx.height = Math.max(100, informacion.length * 30);\n            \n            comparativeChart = new Chart(ctx, {\n                type: 'bar',\n                data: d_graph,\n                options: {\n                    indexAxis: 'y',\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    scales: {\n                        x: {\n                            stacked: true,\n                            max: 100,\n                            beginAtZero: true\n                        },\n                        y: {\n                            stacked: true,\n                            beginAtZero: true\n                        }\n                    }\n                }\n            });\n            console.log('Comparative chart created successfully');\n        } else {\n            console.error('Comparative chart canvas not found');\n        }\n    }\n\n    /**\n     * Add pagination item\n     */\n    function agregaItemPag(elem, i) {\n        return elem + '<li class=\"page-item\" id=\"page' + i + '\"><a class=\"page-link\" href=\"#pag-content\" onclick=\"goToPage(' + i + '); return false;\">' + i + '</a></li>';\n    }\n\n    /**\n     * Next page\n     */\n    function pageNext() {\n        if(pageCurrent < items) {\n            pageCurrent++;\n            getInformationToPage();\n        }\n    }\n\n    /**\n     * Previous page\n     */\n    function pagePrev() {\n        if(pageCurrent > 1) {\n            pageCurrent--;\n            getInformationToPage();\n        }\n    }\n\n    /**\n     * Go to specific page\n     */\n    function goToPage(page) {\n        pageCurrent = parseInt(page);\n        getInformationToPage();\n    }\n\n    /**\n     * Get minimum index\n     */\n    function getMinIndex(n) {\n        if(n - 1 === 0) {\n            return 0;\n        } else if(n - 1 > 0) {\n            return (n - 1) * 10;\n        }\n        return 0;\n    }\n\n    /**\n     * Get maximum index\n     */\n    function getMaxIndex(n) {\n        return n * 10;\n    }\n\n    // Exponer funciones globalmente para los onclick handlers\n    window.pageNext = pageNext;\n    window.pagePrev = pagePrev;\n    window.goToPage = goToPage;\n    window.getMinIndex = getMinIndex;\n    window.getMaxIndex = getMaxIndex;\n\n    return {\n        init: init\n    };\n});"],"names":["define","$","Chart","Ajax","Templates","Notification","GraphicsDashboard","pageCurrent","items","informacion","comparativeChart","hideLoader","modal","obtenerGraficas","peticion","serializeArray","push","name","value","ajax","type","url","M","cfg","wwwroot","data","dataType","done","console","log","destroy","document","getElementById","innerHTML","cleanDiv","html","length","data_labels","arr_completado_percantage","arr_nocompletado_percentage","i","info","title","Math","max","percentage","approved_users","percentage_not_approved","toFixed","parseFloat","d_graph","labels","datasets","label","backgroundColor","stack","ctx","height","options","indexAxis","responsive","maintainAspectRatio","scales","x","stacked","beginAtZero","y","error","comparative","undefined","query","filtros","prueba","JSON","parse","custom","prop","institution","f_uo","stringify","n","round","itemsPage","agregaItemPag","getInformationToPage","fail","error2","min","getMinIndex","getMaxIndex","removeClass","addClass","course","chart","id","enrolled_users","printCardCourseInfo","setTimeout","course_instance","course_info","renderCourseChart","printCardSinInfo","info_copy","na","not_approved_users","dec","split","comparative_graph","individual_graph","elem","window","pageNext","pagePrev","goToPage","page","parseInt","init","ready","each","index","element","Choices","removeItemButton","searchEnabled","placeholderValue","searchPlaceholderValue","placeholder","on","e","preventDefault"],"mappings":"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"}