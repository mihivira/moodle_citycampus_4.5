define(["jquery","jqueryui","mod_icontent/cookiehandler"],function(a,t,e){function n(){if(!a("#idcommentnote").val().trim())return a("#idcommentnote").focus().val(""),!1;var e=a(this),t={action:"savereturnpagenotes",id:a(this).attr("data-cmid"),pageid:a(this).attr("data-pageid"),sesskey:a(this).attr("data-sesskey"),comment:a("#idcommentnote").val(),tab:"note",private:a("#idprivate").is(":checked")?1:0,featured:a("#idfeatured").is(":checked")?1:0,doubttutor:0};s(e),t="&"+a.param(t),a.ajax({type:"POST",dataType:"json",url:"ajax.php",data:t,success:function(t){a("#idpagenotesnote").html(t.notes),a("#idcommentnote").val(""),a("#messagenotes").text(t.totalnotes),i(e)}})}function o(){if(!a("#idcommentdoubt").val().trim())return a("#idcommentdoubt").focus().val(""),!1;var e=a(this),t={action:"savereturnpagenotes",id:a(this).attr("data-cmid"),pageid:a(this).attr("data-pageid"),sesskey:a(this).attr("data-sesskey"),comment:a("#idcommentdoubt").val(),tab:"doubt",doubttutor:a("#iddoubttutor").is(":checked")?1:0,private:0,featured:0};s(e),t="&"+a.param(t),a.ajax({type:"POST",dataType:"json",url:"ajax.php",data:t,success:function(t){a("#idpagenotesdoubt").html(t.notes),a("#idcommentdoubt").val(""),a("#messagedoubt").text(t.totalnotes),i(e)}})}function s(t){t.hide(),a(".icontent-page").children(".fulltextpage").prepend(a("<div />").addClass("loading").html('<img src="pix/loading.gif" alt="Loading" class="img-loading" />')).css("opacity","0.5")}function i(t){t.show(),a(".icontent-page").children(".fulltextpage").css("opacity","1").children(".loading").remove(),t.removeAttr("disabled")}function c(){var e=a(this).children("span"),t={action:"likenote",id:a(this).attr("data-cmid"),pagenoteid:a(this).attr("data-pagenoteid"),sesskey:a(this).attr("data-sesskey")},t="&"+a.param(t);a.ajax({type:"POST",dataType:"json",url:"ajax.php",data:t,success:function(t){e.text(t.likes)}})}function d(t){t=t.data.lastcomment;a(this).parent(".buttonscomment").parent(".notecomment").text(t)}function r(){var e=a(this).parent(".buttonscomment").parent(".notecomment"),t=e.children(".textnotecomment").val();if(!t.trim())return e.children(".textnotecomment").focus().val(""),!1;t={action:"editnote",id:e.attr("data-cmid"),pagenoteid:e.attr("data-pagenoteid"),sesskey:e.attr("data-sesskey"),comment:t},t="&"+a.param(t);a(this).prop("disabled",!0),a.ajax({type:"POST",dataType:"json",url:"ajax.php",data:t,success:function(t){e.text(t.comment)}})}function l(){var t=a(this).parent(".notefooter").parent(".noterowicontent").children(".notecomment"),e=t.text();t.text("").append(a("<textarea />").addClass("textnotecomment col-11").text(e)).append(a("<div />").addClass("buttonscomment").append(a("<button />").addClass("btnnotesave").html('<i class="fa fa-floppy-o"></i>')).append(a("<button />").addClass("btnnotecancel").html('<i class="fa fa-times"></i>'))),a(".textnotecomment").focus(),a(".btnnotecancel").click({lastcomment:e},d),a(".btnnotesave").click(r)}function m(){a(this).parent(".buttonscomment").parent(".notecomment").children(".replynotecomment").remove(),a(this).parent(".buttonscomment").remove()}function p(){var e=a(this).parent(".buttonscomment").parent(".notecomment"),t=e.children(".replynotecomment").val();if(!t.trim())return e.children(".replynotecomment").focus().val(""),!1;t={action:"replynote",id:e.attr("data-cmid"),parent:e.attr("data-pagenoteid"),sesskey:e.attr("data-sesskey"),comment:t},t="&"+a.param(t);a(this).prop("disabled",!0),a.ajax({type:"POST",dataType:"json",url:"ajax.php",data:t,success:function(t){a("#message"+t.tab).text(t.totalnotes),a("#pnote"+parseInt(t.parent)).after(t.reply),e.children(".replynotecomment").remove(),e.children(".buttonscomment").remove()}})}function u(){var t=a(this).parent(".notefooter").parent(".noterowicontent").children(".notecomment");t.children(".replynotecomment").length||(a(".replynotecomment").remove(),a(".buttonscomment").remove(),t.append(a("<textarea />").addClass("replynotecomment col").attr("required","required").attr("maxlength",1024)).append(a("<div />").addClass("buttonscomment").append(a("<button />").addClass("btnnotereplysave").html('<i class="fa fa-floppy-o"></i>')).append(a("<button />").addClass("btnnotereplycancel").html('<i class="fa fa-times"></i>')))),a(".replynotecomment").focus(),a(".btnnotereplycancel").click(m),a(".btnnotereplysave").click(p)}function h(){"yes"==e.cookie("highcontrast")?(e.cookie("highcontrast",null,{path:"/"}),a(".fulltextpage").removeClass("highcontrast").css("background-color","#FCFCFC")):(e.cookie("highcontrast","yes",{expires:7,path:"/"}),a(".fulltextpage").addClass("highcontrast").css({"background-color":"#000000","background-image":"none"}))}function f(){var t=a(this).serialize(),t={action:"saveattempt",id:parseInt(a("#idhfieldcmid").val()),sesskey:a("#idhfieldsesskey").val(),formdata:t};return a(".btn-sendanswers").prop("disabled",!0),a.ajax({type:"POST",dataType:"json",url:"ajax.php",data:t,success:function(t){a("#idquestionsarea").html(t.grid)}}),!1}function g(t){t=t.data.idtogle;a(t).toggle("fade",{},500),a(this).toggleClass("closed",500),a(this).hasClass("closed")?a(this).children("i").removeClass("fa-caret-down").addClass("fa-caret-right"):a(this).children("i").removeClass("fa-caret-right").addClass("fa-caret-down")}function v(){a(this).hide(),a(".suspension-points").hide(),a(".read-more-target").show("fade"),a(".read-more-state-off").show()}function b(){a(this).hide(),a(".read-more-target").hide("fade"),a(".suspension-points").show(),a(".read-more-state-on").show()}return{init:function(){var t=a("#idicontentpages");t.on("click","#idbtnsavenote",n),t.on("click","#idbtnsavedoubt",o),t.on("click","#idtitlenotes",{idtogle:"#idfulltab"},g),t.on("click","#idtitlequestionsarea",{idtogle:"#idcontentquestionsarea"},g),t.on("click",".read-more-state-on",v),t.on("click",".read-more-state-off",b),t.on("click",".likenote",c),t.on("click",".editnote",l),t.on("click",".replynote",u),t.on("click",".togglehighcontrast",h),t.on("submit","#idformquestions",f)}}});